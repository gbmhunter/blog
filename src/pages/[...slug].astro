---
// @ts-nocheck
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { getCollection } from 'astro:content';

import Aside from 'src/components/Aside.astro';
import ChildPages from 'src/components/ChildPages.astro';
import CircuitJs from 'src/components/CircuitJs.astro';
import Image from 'src/components/Image.astro';
import WarningIsNotes from 'src/components/WarningIsNotes.astro';
import WrappableRow from 'src/components/WrappableRow.astro';

import { getRoutablePages, getSidebarData } from 'src/js/PageHierarchy';
import { correctUpdatesSlugs, getAllCollections } from 'src/js/Collections';

export async function getStaticPaths() {
  // let pagesCollection = await getCollection('pages');
  // pagesCollection = [];

  // All pages in the updates collection will have a slug prefixed with "updates/"
  // let updatesCollection = await getCollection('updates');
  // correctUpdatesSlugs(updatesCollection);

  // Merge the updates collection into the pages collection
  // const combinedCollection = (pagesCollection as any).concat(updatesCollection);

  const combinedCollection = await getAllCollections();


  // Uncomment this line if you want to test code logic with a smaller collection
  // let pagesCollection = await getCollection('test');
  
  // Trim down to first 10
  // pagesCollection = pagesCollection.slice(0, 2);

  const routablePages = getRoutablePages(combinedCollection);
  const sidebarData = getSidebarData(combinedCollection);

  let staticPaths = [];
  for (let pageRoute of routablePages) {

    if (pageRoute.slug === 'index') {
      pageRoute.slug = undefined;
    }

    staticPaths.push({
      params: { slug: pageRoute.slug },
      props: { 
        frontmatter: pageRoute.data,
        render: pageRoute.render,
        sidebarData: sidebarData,
      },
    });
  }

  return staticPaths;
}

const { frontmatter, render, sidebarData } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render();

---
<!-- Any unsupported entries will be stripped from the frontmatter. Can add new props though! -->
<StarlightPage 
  frontmatter={{ ...frontmatter }}
  headings={headings}
  sidebar={sidebarData.items as any}
  customFrontmatter={frontmatter}
>
  <Content components={{
    Aside: Aside,
    ChildPages: ChildPages,
    CircuitJs: CircuitJs,
    Image: Image,
    WarningIsNotes: WarningIsNotes,
    WrappableRow: WrappableRow,
  }} /> 
</StarlightPage>